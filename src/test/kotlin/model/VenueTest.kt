package org.kotlin.ktor.model

import io.ktor.client.request.*
import io.ktor.client.statement.*
import io.ktor.server.testing.*
import kotlinx.serialization.json.Json
import kotlinx.serialization.json.JsonObject
import model.ApiUrlLink
import model.Venue
import org.junit.Test
import org.kotlin.ktor.module
import kotlin.test.assertEquals
import kotlin.test.assertNotNull

class VenueTest {

    @Test
    fun fillVenueDataTest() = testApplication {
        application {
            module(testing = true)
        }

        client.get("/api/v1/delivery-order-price?venue_slug=" + "home-assignment-venue-helsinki" + "&cart_value=1000&" + "user_lat=60.17094&user_lon=24.93087")
            .apply {
                assertEquals(true, bodyAsText().contains("total_price\":"))
                assertEquals(true, bodyAsText().contains("small_order_surcharge\":"))
                assertEquals(true, bodyAsText().contains("cart_value\":"))
                assertEquals(true, bodyAsText().contains("distance\":"))
                assertEquals(true, bodyAsText().contains("fee\":"))
            }
    }

    @Test
    fun iterateThrowTheMapAndFillNeededFieldsTest(){
        val testVenue = Venue("TestName",true)
        val testMapOfStaticVenueData =  Json.parseToJsonElement("""{"venue":{"id":"66fe419cd46e8b9f53fd6e5c","image_url":"https://image-resizer-proxy.development.dev.woltapi.com/assets/677fab0c2e9a6361713418b6","image_blurhash":"j2jQRa00hGTt;;gPmXKGcPTsPbpl","brand_logo_image_url":null,"brand_logo_image_blurhash":null,"brand_slug":null,"brand_name":null,"name":"Home Assignment Venue Helsinki","description":"This is a venue that's used in engineering home assignment. Please don't modify!","rating":null,"opening_times_schedule":[{"day":"Monday","formatted_times":"All day"},{"day":"Tuesday","formatted_times":"All day"},{"day":"Wednesday","formatted_times":"All day"},{"day":"Thursday","formatted_times":"All day"},{"day":"Friday","formatted_times":"All day"},{"day":"Saturday","formatted_times":"All day"},{"day":"Sunday","formatted_times":"All day"}],"delivery_times_schedule":[{"day":"Monday","formatted_times":"All day"},{"day":"Tuesday","formatted_times":"All day"},{"day":"Wednesday","formatted_times":"All day"},{"day":"Thursday","formatted_times":"All day"},{"day":"Friday","formatted_times":"All day"},{"day":"Saturday","formatted_times":"All day"},{"day":"Sunday","formatted_times":"All day"}],"group_order_enabled":true,"share_url":"https://wolt-com.development.dev.woltapi.com/fi/fin/helsinki/restaurant/home-assignment-venue-helsinki","delivery_methods":["takeaway","homedelivery"],"currency":"EUR","active_menu":null,"address":"Pohjoinen Rautatiekatu 21","city":"Helsinki","country":"FIN","type":"purchase","website":null,"substitutions_enabled":null,"post_code":"00100","product_line":"restaurant","secondary_product_line":"none","phone":null,"self_delivery":false,"timezone":"Europe/Helsinki","delivery_base_price":190,"delivery_geo_range":{"bbox":null,"type":"Polygon","coordinates":[[[24.77798142454613,60.057872481327195],[24.736928681312932,60.07459593838405],[24.703160875825034,60.094984998823186],[24.677980259331353,60.11826212767934],[24.66236796128651,60.14353791589927],[24.65694428928704,60.16984447982529],[24.661941836289664,60.19617212481639],[24.677192879654946,60.221507947052366],[24.7021321081485,60.24487492377632],[24.73581514283841,60.2653699679472],[24.776952641411924,60.28219940975918],[24.823959026294474,60.29471042371552],[24.87501410515314,60.302417050867746],[24.928135119999993,60.30501967088782],[24.981256134846845,60.302417050867746],[25.032311213705512,60.29471042371552],[25.07931759858809,60.28219940975918],[25.120455097161603,60.2653699679472],[25.154138131851486,60.24487492377632],[25.17907736034504,60.221507947052366],[25.194328403710323,60.19617212481639],[25.19932595071297,60.16984447982529],[25.193902278713477,60.14353791589927],[25.178289980668634,60.11826212767934],[25.159663039906956,60.1010432601264],[24.787678030715536,60.05529698419671],[24.77798142454613,60.057872481327195]]]},"service_fee_short_description":null,"service_fee_estimate":null,"feature_croatia_currency_selection_enabled":false,"show_eco_packaging":false,"is_pickup_friendly":false,"age_verification_method":"age_verification","trader_information":null,"show_delivery_preestimate_by_time":false,"merchant":{"id":"66fe40dfd46e8b9f53fd6e53","name":"Home Assignment merchant","business_id":"home-assignment-id-123","street_address":"Eteläinen Rautatiekatu 10","city":"Helsinki","post_code":"00100","country":"Finland"},"digital_services_act_information":{"name":"Home Assignment merchant","business_id":"home-assignment-id-123","address":"Eteläinen Rautatiekatu 10, 00100, Helsinki, Finland","self_certification":"The Partner is committed to only offering products and/or services that comply with the applicable laws.","report_item_url":"https://www.surveymonkey.com/r/VHFTCJX"},"slug":"home-assignment-venue-helsinki","venue_supports_wolt_pay":false,"group_order_id":null,"info":{"venue_info_service_fee_description":null,"venue_info_order_minimum":"€10.00","venue_info_base_delivery_price":"€1.90"},"zero_distance_fees":{"delivery_price":190}},"venue_raw":{"id":"66fe419cd46e8b9f53fd6e5c","name":"Home Assignment Venue Helsinki","image_url":"https://image-resizer-proxy.development.dev.woltapi.com/assets/677fab0c2e9a6361713418b6","image_blurhash":"j2jQRa00hGTt;;gPmXKGcPTsPbpl","brand_logo_image_url":null,"brand_logo_image_blurhash":null,"description":"This is a venue that's used in engineering home assignment. Please don't modify!","group_order_enabled":true,"share_url":"https://wolt-com.development.dev.woltapi.com/fi/fin/helsinki/restaurant/home-assignment-venue-helsinki","delivery_methods":["takeaway","homedelivery"],"currency":"EUR","opening_times":{"monday":[{"type":"open","value":0}],"tuesday":[],"wednesday":[],"thursday":[],"friday":[],"saturday":[],"sunday":[{"type":"close","value":86400}]},"preorder_specs":{"preorder_only":false,"time_step":5,"homedelivery_spec":{"earliest_timedelta":60,"latest_timedelta":8,"preorder_times":{"monday":[{"type":"open","value":0}],"tuesday":null,"wednesday":null,"thursday":null,"friday":null,"saturday":null,"sunday":[{"type":"close","value":86400}]}},"takeaway_spec":{"earliest_timedelta":50,"latest_timedelta":8,"preorder_times":{"monday":[{"type":"open","value":0}],"tuesday":null,"wednesday":null,"thursday":null,"friday":null,"saturday":null,"sunday":[{"type":"close","value":86400}]}},"eatin_spec":null},"ncd_allowed":true,"tipping":{"currency":"EUR","tip_amounts":[100,200,500],"max_amount":2000,"min_amount":50,"type":"pre_tipping_amount"},"delivery_note":null,"public_visible":false,"bag_fee":null,"comment_disabled":false,"short_description":null,"city_id":"58a462711c5ea23ce19e15ca","merchant":"66fe40dfd46e8b9f53fd6e53","show_allergy_disclaimer_on_menu":false,"price_range":0,"item_cards_enabled":false,"service_fee_description":"Helps us improve our delivery service further by bringing you new features to enjoy and providing exceptional customer support. The service fee may vary based on order value, selected venue, or delivery method.","food_tags":null,"allowed_payment_methods":["card","card_raw"],"food_safety_reports":null,"is_wolt_plus":false,"categories":null,"rating":null,"location":{"bbox":null,"type":"Point","coordinates":[24.92813512,60.17012143]},"string_overrides":{"weighted_items_popup_disclaimer":null,"restricted_item_bottom_sheet_title":"Age verification needed","restricted_item_bottom_sheet_info":"Your order includes age-restricted items. Please confirm that you and the recipient are legally allowed to buy them. The courier will ask for a valid photo ID at handoff.","restricted_item_bottom_sheet_confirm":"Yes, I'm allowed"}},"order_minimum":1000}""") as JsonObject
        val testMapOfDynamicVenueData =  Json.parseToJsonElement("""{"venue":{"delivery_open_status":{"value":"Open all day","style":{"icon":null,"type":"OPEN"},"is_open":true,"now":"2025-02-15T18:11:55.465927+02:00","previous_open":null,"next_open":null,"next_close":null,"next_close_time_localized":null},"id":"66fe419cd46e8b9f53fd6e5c","open_status":{"value":"Open all day","style":{"icon":null,"type":"OPEN"},"is_open":true,"now":"2025-02-15T18:11:55.465927+02:00","previous_open":null,"next_open":null,"next_close":null,"next_close_time_localized":null},"online":true,"time_slots_schedule":null,"banners":[],"header":{"delivery_method_default":"UNAVAILABLE","delivery_method_statuses":[{"delivery_method":"UNAVAILABLE","metadata":[{"type":"STRING","link":null,"icon":null,"style":"NORMAL","value":"Open all day"},{"type":"STRING","link":null,"icon":null,"style":"NORMAL","value":"Min. order €10.00"}],"call_to_action":{"icon":"LOCATION","style":"NO_FILL","enabled":true,"configurable":false,"value":"Choose location"},"group_order_button":{"enabled":false,"visible":false},"notification":null,"disclaimer":null}]},"delivery_configs":[{"label":"Standard","method":"homedelivery","schedule":"standard","estimate":{"label":"40-50 min","min":40,"mean":45,"max":50},"price":null,"tso_schedule":null},{"label":"Standard","method":"takeaway","schedule":"standard","estimate":{"label":"10-30 min","min":10,"mean":20,"max":30},"price":null,"tso_schedule":null}]},"venue_raw":{"id":"66fe419cd46e8b9f53fd6e5c","favourite":false,"preestimate_total":{"min":40,"max":50,"mean":45},"preestimate_preparation":{"min":10,"max":30,"mean":20},"alive":true,"applepay_callback_flow_enabled":false,"googlepay_callback_flow_enabled":false,"discounts":[],"surcharges":[],"delivery_specs":{"delivery_enabled":true,"order_minimum_no_surcharge":1000,"order_minimum_possible":1000,"delivery_times":{"monday":[{"type":"open","value":0}],"tuesday":null,"wednesday":null,"thursday":null,"friday":null,"saturday":null,"sunday":[{"type":"close","value":86400}]},"original_delivery_price":190,"delivery_pricing":{"base_price":190,"price_ranges":[{"min":0,"max":1000,"a":1000,"b":-1.0,"flag":null,"custom_distance_ranges":null},{"min":1000,"max":0,"a":0,"b":0.0,"flag":null,"custom_distance_ranges":null}],"distance_ranges":[{"min":0,"max":500,"a":0,"b":0.0,"flag":null},{"min":500,"max":1000,"a":100,"b":0.0,"flag":null},{"min":1000,"max":1500,"a":200,"b":0.0,"flag":null},{"min":1500,"max":2000,"a":200,"b":1.0,"flag":null},{"min":2000,"max":0,"a":0,"b":0.0,"flag":null}],"meta":{"subscription_minimum_basket":null,"subscription_max_distance":null,"subscription_plan_id":null}},"delivery_pricing_with_subscription":null,"delivery_pricing_without_subscription":null,"geo_range":{"bbox":null,"type":"Polygon","coordinates":[[[24.77798142454613,60.057872481327195],[24.736928681312932,60.07459593838405],[24.703160875825034,60.094984998823186],[24.677980259331353,60.11826212767934],[24.66236796128651,60.14353791589927],[24.65694428928704,60.16984447982529],[24.661941836289664,60.19617212481639],[24.677192879654946,60.221507947052366],[24.7021321081485,60.24487492377632],[24.73581514283841,60.2653699679472],[24.776952641411924,60.28219940975918],[24.823959026294474,60.29471042371552],[24.87501410515314,60.302417050867746],[24.928135119999993,60.30501967088782],[24.981256134846845,60.302417050867746],[25.032311213705512,60.29471042371552],[25.07931759858809,60.28219940975918],[25.120455097161603,60.2653699679472],[25.154138131851486,60.24487492377632],[25.17907736034504,60.221507947052366],[25.194328403710323,60.19617212481639],[25.19932595071297,60.16984447982529],[25.193902278713477,60.14353791589927],[25.178289980668634,60.11826212767934],[25.159663039906956,60.1010432601264],[24.787678030715536,60.05529698419671],[24.77798142454613,60.057872481327195]]]}},"self_delivery":false,"payment_method_restrictions":null,"discounts_restrictions_text":"The following categories are excluded from offers: beer, wine, alcohol, tobacco, nicotine products, smokers items and accessories, medicine, baby formula, newspaper, magazines and lottery scratchcards","preorder_specs":{"preorder_only":false,"time_step":5,"homedelivery_spec":{"earliest_timedelta":60,"latest_timedelta":8,"preorder_times":{"monday":[{"type":"open","value":0}],"tuesday":null,"wednesday":null,"thursday":null,"friday":null,"saturday":null,"sunday":[{"type":"close","value":86400}]}},"takeaway_spec":{"earliest_timedelta":50,"latest_timedelta":8,"preorder_times":{"monday":[{"type":"open","value":0}],"tuesday":null,"wednesday":null,"thursday":null,"friday":null,"saturday":null,"sunday":[{"type":"close","value":86400}]}},"eatin_spec":null},"group_order_id":""},"is_venue_favourite":false,"order_status":{"value":""},"order_minimum":1000,"do_use_backend_pricing":"no"}""") as JsonObject

        testVenue.iterateThrowTheMapAndFillNeededFields(testMapOfStaticVenueData, ApiUrlLink.STATIC_API.value)
        testVenue.iterateThrowTheMapAndFillNeededFields(testMapOfDynamicVenueData, ApiUrlLink.DYNAMIC_API.value)

        assertNotNull(testVenue.coordinates)
        assertNotNull(testVenue.orderMinimumNoSurcharge)
        assertNotNull(testVenue.basePrice)
        assertNotNull(testVenue.distanceRanges)
    }

    @Test
    fun recursiveGetNeededValueFromJsonTest(){

        val testVenue = Venue("TestName",true)
        val testJsonFieldName = "FieldName"
        val testJsonFieldValue = "FieldValue"
        val testJsonObject = Json.parseToJsonElement("""{"$testJsonFieldName":$testJsonFieldValue}""") as JsonObject

        testVenue.recursiveGetNeededValueFromJson(testJsonObject, listOf(testJsonFieldName))

        assertEquals(testJsonFieldValue, testVenue.recursiveGetNeededValueFromJson(testJsonObject, listOf(testJsonFieldName)).toString())
    }
}